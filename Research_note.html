<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识关系可视化工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        #background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center center;
            transition: background-image 0.5s ease-in-out;
        }
        .graph-node {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .graph-node circle {
            stroke: #475569;
            stroke-width: 1.5px;
        }
        .graph-node:hover circle, .graph-node.selected circle {
            transform: scale(1.1);
            stroke: #4f46e5;
            stroke-width: 3px;
        }
        .graph-node:hover text, .graph-node.selected text {
            font-weight: 600;
            fill: #4f46e5;
        }
        .graph-link {
            stroke: #94a3b8;
            stroke-opacity: 0.6;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Toast Notifications */
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #22c55e; }
        .toast.info { background-color: #3b82f6; }
        .toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="overflow-hidden">
    <div id="background-overlay"></div>
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    <div class="flex h-screen bg-slate-50/80 backdrop-blur-sm">
        <!-- Left Panel: Categories -->
        <aside class="w-64 bg-white/80 border-r border-slate-200 flex flex-col">
            <div class="px-6 py-4 border-b border-slate-200">
                <h1 class="text-xl font-bold text-slate-800">知识类别</h1>
            </div>
            <nav id="category-list" class="flex-1 p-4 space-y-2 overflow-y-auto">
                <!-- Categories will be dynamically inserted here -->
            </nav>
            <div class="px-4 py-4 border-t border-slate-200 space-y-2">
                 <button id="export-btn" class="w-full inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none">导出笔记</button>
                 <button id="import-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">导入笔记</button>
                 <input type="file" id="import-file" class="hidden" accept="application/json">
                 <button id="wallpaper-btn" class="mt-2 w-full inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none">上传壁纸</button>
                 <button id="remove-wallpaper-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none">移除壁纸</button>
                 <input type="file" id="wallpaper-file" class="hidden" accept="image/*">
            </div>
        </aside>

        <!-- Middle Panel: Notes and Editor -->
        <main class="flex-1 flex flex-col bg-transparent">
            <div class="px-8 py-4 border-b border-slate-200 bg-white/80">
                 <h2 id="current-category-title" class="text-2xl font-bold text-slate-800">所有笔记</h2>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <!-- Notes List -->
                <div class="w-1/3 border-r border-slate-200 overflow-y-auto p-6 bg-white/80">
                    <h3 class="text-lg font-semibold mb-4 text-slate-700">笔记列表</h3>
                    <div id="note-list" class="space-y-4">
                        <!-- Note cards will be dynamically inserted here -->
                    </div>
                </div>
                <!-- Note Editor -->
                <div class="w-2/3 overflow-y-auto p-8">
                    <div class="bg-white/90 p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 id="form-title" class="text-lg font-semibold mb-4 text-slate-700">添加新笔记</h3>
                        <form id="note-form" class="space-y-4">
                            <input type="hidden" id="note-id">
                            <div>
                                <label for="note-title" class="block text-sm font-medium text-slate-600">标题</label>
                                <input type="text" id="note-title" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="note-content" class="block text-sm font-medium text-slate-600">内容</label>
                                <textarea id="note-content" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></textarea>
                            </div>
                            <div>
                                <label for="note-category" class="block text-sm font-medium text-slate-600">类别</label>
                                <input type="text" id="note-category" required placeholder="例如: 编程, 历史" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="note-tags" class="block text-sm font-medium text-slate-600">标签 (用逗号分隔)</label>
                                <input type="text" id="note-tags" placeholder="例如: javascript, web开发" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            </div>
                            <div id="relations-container" class="hidden">
                                <label class="block text-sm font-medium text-slate-600">关联笔记</label>
                                <div id="note-relations" class="mt-2 p-3 border border-slate-200 rounded-md max-h-32 overflow-y-auto space-y-2">
                                    <!-- Checkboxes for relations will be dynamically inserted here -->
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">保存笔记</button>
                                <button type="button" id="clear-form-btn" class="inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none">清空</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel: Graph Visualization -->
        <aside class="w-1/3 bg-white/80 border-l border-slate-200 flex flex-col">
            <div class="px-6 py-4 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">关系预览</h2>
            </div>
            <div id="graph-container" class="flex-1 relative">
                <div id="tooltip" class="absolute bg-slate-800 text-white text-xs rounded py-1 px-2 pointer-events-none opacity-0 transition-opacity"></div>
            </div>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let notes = JSON.parse(localStorage.getItem('knowledgeBaseNotes')) || [
                { id: '1', title: 'JavaScript 基础', content: '变量、数据类型、函数...', category: '编程', tags: ['javascript', '入门'], relations: ['2'] },
                { id: '2', title: 'DOM 操作', content: '如何使用 JS 与 HTML 交互', category: '编程', tags: ['javascript', 'web'], relations: ['3'] },
                { id: '3', title: '异步编程', content: 'Callbacks, Promises, Async/Await', category: '编程', tags: ['javascript', '高级'], relations: [] },
                { id: '4', title: '古罗马历史', content: '从共和国到帝国', category: '历史', tags: ['罗马', '古代史'], relations: [] }
            ];
            let currentCategory = 'all';

            // --- DOM ELEMENTS ---
            const backgroundOverlay = document.getElementById('background-overlay');
            const categoryList = document.getElementById('category-list');
            const noteList = document.getElementById('note-list');
            const noteForm = document.getElementById('note-form');
            const formTitle = document.getElementById('form-title');
            const noteIdInput = document.getElementById('note-id');
            const noteTitleInput = document.getElementById('note-title');
            const noteContentInput = document.getElementById('note-content');
            const noteCategoryInput = document.getElementById('note-category');
            const noteTagsInput = document.getElementById('note-tags');
            const currentCategoryTitle = document.getElementById('current-category-title');
            const clearFormBtn = document.getElementById('clear-form-btn');
            const relationsContainer = document.getElementById('relations-container');
            const noteRelationsDiv = document.getElementById('note-relations');
            const graphContainer = document.getElementById('graph-container');
            const tooltip = document.getElementById('tooltip');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file');
            const wallpaperBtn = document.getElementById('wallpaper-btn');
            const wallpaperFileInput = document.getElementById('wallpaper-file');
            const removeWallpaperBtn = document.getElementById('remove-wallpaper-btn');

            // --- UTILITY FUNCTIONS ---
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            // --- D3 GRAPH SETUP ---
            let simulation, svg;

            function setupGraph() {
                const width = graphContainer.clientWidth;
                const height = graphContainer.clientHeight;

                d3.select(graphContainer).select("svg").remove();

                svg = d3.select(graphContainer).append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [-width / 2, -height / 2, width, height])
                    .call(d3.zoom().on("zoom", (event) => {
                        svg.attr("transform", event.transform);
                    })).append("g");

                simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("x", d3.forceX())
                    .force("y", d3.forceY());
            }

            // --- RENDER FUNCTIONS ---
            function saveNotes() {
                localStorage.setItem('knowledgeBaseNotes', JSON.stringify(notes));
            }

            function renderAll() {
                renderCategories();
                renderNotes();
                updateGraph();
            }

            function renderCategories() {
                const categories = ['all', ...new Set(notes.map(note => note.category))];
                categoryList.innerHTML = categories.map(cat => `
                    <a href="#" class="block px-4 py-2 text-sm font-medium rounded-md ${currentCategory === cat ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'}" data-category="${cat}">
                        ${cat === 'all' ? '所有类别' : cat}
                    </a>
                `).join('');
            }

            function renderNotes() {
                const filteredNotes = notes.filter(note => currentCategory === 'all' || note.category === currentCategory);
                currentCategoryTitle.textContent = currentCategory === 'all' ? '所有笔记' : `类别: ${currentCategory}`;
                const currentNoteId = noteIdInput.value;
                
                noteList.innerHTML = filteredNotes.length ? filteredNotes.map(note => `
                    <div class="border p-4 rounded-lg bg-white/90 cursor-pointer hover:shadow-md transition-all ${note.id === currentNoteId ? 'border-indigo-500 shadow-md' : 'border-slate-200'}" data-note-id="${note.id}">
                        <h4 class="font-semibold text-slate-800">${note.title}</h4>
                        <p class="text-sm text-slate-500 mt-1 truncate">${note.content}</p>
                        <div class="mt-3 flex flex-wrap gap-2">
                            ${note.tags.map(tag => `<span class="bg-slate-100 text-slate-600 text-xs font-medium px-2 py-1 rounded-full">${tag}</span>`).join('')}
                        </div>
                         <div class="mt-3 text-right">
                             <button class="delete-btn text-xs text-red-500 hover:text-red-700" data-note-id="${note.id}">删除</button>
                         </div>
                    </div>
                `).join('') : '<p class="text-sm text-slate-500">没有找到笔记。</p>';
            }

            function updateGraph() {
                if (!graphContainer.clientWidth) return;
                if (!svg) setupGraph();

                const filteredNotes = notes.filter(note => currentCategory !== 'all' && note.category === currentCategory);
                const currentNoteId = noteIdInput.value;

                if (filteredNotes.length === 0) {
                     svg.selectAll("*").remove();
                     return;
                }

                const nodesData = filteredNotes.map(d => ({...d}));
                const linksData = [];
                filteredNotes.forEach(note => {
                    note.relations.forEach(targetId => {
                        if (filteredNotes.some(n => n.id === targetId)) {
                             linksData.push({ source: note.id, target: targetId });
                        }
                    });
                });

                svg.selectAll(".graph-link").remove();
                const link = svg.selectAll(".graph-link")
                    .data(linksData, d => `${d.source.id}-${d.target.id}`)
                    .enter()
                    .append("line")
                    .attr("class", "graph-link")
                    .attr("stroke-width", 2);

                svg.selectAll(".graph-node").remove();
                const node = svg.selectAll(".graph-node")
                    .data(nodesData, d => d.id)
                    .enter()
                    .append("g")
                    .attr("class", d => `graph-node ${d.id === currentNoteId ? 'selected' : ''}`)
                    .call(drag(simulation))
                    .on('click', (event, d) => {
                        const noteToEdit = notes.find(n => n.id === d.id);
                        if (noteToEdit) {
                            populateForm(noteToEdit);
                        }
                    });


                node.append("circle")
                    .attr("r", 10)
                    .attr("fill", "#fff");

                node.append("text")
                    .text(d => d.title)
                    .attr("x", 15)
                    .attr("y", 5)
                    .attr("fill", "#334155");

                node.on('mouseover', (event, d) => {
                    tooltip.style('opacity', 1)
                           .html(`<b>${d.title}</b><br><small>${d.tags.join(', ')}</small>`)
                           .style('left', (event.pageX + 10) + 'px')
                           .style('top', (event.pageY - 28) + 'px');
                }).on('mouseout', () => {
                    tooltip.style('opacity', 0);
                });

                simulation.nodes(nodesData);
                simulation.force("link").links(linksData);
                simulation.alpha(1).restart();

                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("transform", d => `translate(${d.x}, ${d.y})`);
                });
            }
            
            // --- FORM & EVENT HANDLERS ---
            function clearForm() {
                noteForm.reset();
                noteIdInput.value = '';
                formTitle.textContent = '添加新笔记';
                clearFormBtn.textContent = '清空';
                relationsContainer.classList.add('hidden');
                noteRelationsDiv.innerHTML = '';
                renderAll();
            }

            function populateForm(note) {
                formTitle.textContent = '编辑笔记: ' + note.title;
                clearFormBtn.textContent = '新建笔记';
                noteIdInput.value = note.id;
                noteTitleInput.value = note.title;
                noteContentInput.value = note.content;
                noteCategoryInput.value = note.category;
                noteTagsInput.value = note.tags.join(', ');
                populateRelations(note);
                renderAll(); // Re-render to highlight selected note
            }

            function populateRelations(note) {
                const possibleRelations = notes.filter(n => n.category === note.category && n.id !== note.id);
                if (possibleRelations.length > 0) {
                    noteRelationsDiv.innerHTML = possibleRelations.map(n => `
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" value="${n.id}" class="relation-checkbox rounded" ${note.relations.includes(n.id) ? 'checked' : ''}>
                            <span>${n.title}</span>
                        </label>
                    `).join('');
                    relationsContainer.classList.remove('hidden');
                } else {
                    relationsContainer.classList.add('hidden');
                }
            }
            
            noteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = noteIdInput.value;
                const relations = Array.from(document.querySelectorAll('.relation-checkbox:checked')).map(cb => cb.value);

                const noteData = {
                    title: noteTitleInput.value,
                    content: noteContentInput.value,
                    category: noteCategoryInput.value.trim(),
                    tags: noteTagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean),
                    relations: relations
                };

                if (id) { // Update existing note
                    const index = notes.findIndex(note => note.id === id);
                    if (index > -1) {
                        notes[index] = { ...notes[index], ...noteData };
                    }
                } else { // Add new note
                    notes.push({ id: Date.now().toString(), ...noteData });
                }
                
                saveNotes();
                showToast('笔记已成功保存！');
                const justEditedId = id || notes[notes.length - 1].id;
                const justEditedNote = notes.find(n => n.id === justEditedId);
                
                if (justEditedNote) {
                    populateForm(justEditedNote);
                } else {
                    clearForm();
                }
            });

            categoryList.addEventListener('click', (e) => {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    currentCategory = e.target.dataset.category;
                    clearForm(); 
                }
            });

            noteList.addEventListener('click', (e) => {
                const card = e.target.closest('[data-note-id]');
                if (!card) return;

                const noteId = card.dataset.noteId;
                
                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('确定要删除这个笔记吗？')) {
                        notes = notes.filter(n => n.id !== noteId);
                        notes.forEach(n => {
                            n.relations = n.relations.filter(rId => rId !== noteId);
                        });
                        saveNotes();
                        clearForm();
                        showToast('笔记已删除。', 'info');
                    }
                } else {
                    const noteToEdit = notes.find(n => n.id === noteId);
                    if (noteToEdit) {
                        populateForm(noteToEdit);
                    }
                }
            });

            noteCategoryInput.addEventListener('input', () => {
                const id = noteIdInput.value;
                if (id) {
                    const note = notes.find(n => n.id === id);
                    if (note) {
                        const tempNote = {...note, category: noteCategoryInput.value};
                        populateRelations(tempNote);
                    }
                }
            });
            
            clearFormBtn.addEventListener('click', clearForm);

            function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x; d.fy = d.y;
                }
                function dragged(event, d) {
                    d.fx = event.x; d.fy = event.y;
                }
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null; d.fy = null;
                }
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
            }

            // --- IMPORT/EXPORT FUNCTIONS ---
            function exportNotes() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "knowledge-base-backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function importNotes(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedNotes = JSON.parse(e.target.result);
                        if (Array.isArray(importedNotes)) {
                            const existingIds = new Set(notes.map(n => n.id));
                            let addedCount = 0;
                            importedNotes.forEach(note => {
                                if (!existingIds.has(note.id)) {
                                    notes.push(note);
                                    addedCount++;
                                }
                            });
                            saveNotes();
                            renderAll();
                            showToast(`成功导入 ${addedCount} 条新笔记！`);
                        } else { throw new Error("Invalid format"); }
                    } catch (error) {
                        showToast("导入失败：文件格式不正确或已损坏。", 'error');
                    } finally { importFileInput.value = ''; }
                };
                reader.readAsText(file);
            }

            exportBtn.addEventListener('click', exportNotes);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importNotes);

            // --- WALLPAPER FUNCTIONS ---
            function applyWallpaper(imageDataUrl) {
                backgroundOverlay.style.backgroundImage = `url(${imageDataUrl})`;
            }

            function loadWallpaper() {
                const savedWallpaper = localStorage.getItem('knowledgeBaseWallpaper');
                if (savedWallpaper) {
                    applyWallpaper(savedWallpaper);
                }
            }

            function handleWallpaperUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    localStorage.setItem('knowledgeBaseWallpaper', imageDataUrl);
                    applyWallpaper(imageDataUrl);
                    showToast('壁纸设置成功！');
                }
                reader.readAsDataURL(file);
                wallpaperFileInput.value = '';
            }

            function removeWallpaper() {
                 localStorage.removeItem('knowledgeBaseWallpaper');
                 backgroundOverlay.style.backgroundImage = 'none';
                 showToast('壁纸已移除。', 'info');
            }

            wallpaperBtn.addEventListener('click', () => wallpaperFileInput.click());
            wallpaperFileInput.addEventListener('change', handleWallpaperUpload);
            removeWallpaperBtn.addEventListener('click', removeWallpaper);


            // --- INITIALIZATION ---
            loadWallpaper();
            renderAll();
            window.addEventListener('resize', () => {
                if (currentCategory !== 'all') {
                    setupGraph();
                    updateGraph();
                }
            });
            window.addEventListener('beforeunload', (event) => {
                event.preventDefault();
                event.returnValue = '您确定要离开吗？离开前请记得导出笔记以防数据丢失。';
            });
        });
    </script>
</body>
</html>

